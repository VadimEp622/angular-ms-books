# extreme WIP - this was generated by AI. It will absolutely NOT WORK.
# TODO: fix this file, following the the blueprint here: https://docs.render.com/blueprint-spec#docker
#  * additionally, for mysql, use the following guides: 
#      1) https://docs.render.com/deploy-mysql, 
#      2) https://github.com/render-examples/mysql/blob/master/render.yaml

# INFO: you cannot use mysql PRIVATE service on render.com for FREE.


version: '1'
services:

  - type: web
    name: ms-books-app
    env: production
    build:
      context:./backend
      dockerfile:./Dockerfile
    env_vars:
      - DB_HOST=mysqldb
      - DB_USER=${MYSQLDB_USER}
      - DB_PASSWORD=${MYSQLDB_ROOT_PASSWORD}
      - DB_NAME=${MYSQLDB_DATABASE}
      - DB_PORT=${MYSQLDB_LOCAL_PORT}
    volumes:
      - node_modules
      - ./backend:/usr/src/app
    ports:
      - "${NODE_HOST_PORT}:PORT"
    depends_on:
      - mysqldb

  - type: db
    name: mysqldb
    env: production
    image: mysql:8.3
    env_vars:
      - MYSQL_ROOT_PASSWORD=${MYSQLDB_ROOT_PASSWORD}
      - MYSQL_DATABASE=${MYSQLDB_DATABASE}
    volumes:
      - db:/var/lib/mysql
      - ./backend/dbinit/init.sql:/docker-entrypoint-initdb.d/0_init.sql

  - type: web
    name: nginx
    env: production
    build:
      context:./nginx
      dockerfile: Dockerfile
    env_vars:
      - MS_BOOKS_APP_URL=$(ms-books-app).url
    ports:
      - "3050:80"
    depends_on:
      - ms-books-app

resources:
  - type: secret
    name: db-secrets
    env_vars:
      - MYSQLDB_USER
      - MYSQLDB_ROOT_PASSWORD
      - MYSQLDB_DATABASE
      - MYSQLDB_LOCAL_PORT
